<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC/USD Chart with Liquidations</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/3.8.0/lightweight-charts.standalone.production.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #chart-container { 
            width: 100%; 
            height: 90vh; 
        }
        #stats-container {
            height: 10vh;
            background-color: #1E1E1E;
            color: #D3D3D3;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .stat-box {
            text-align: center;
            padding: 5px 15px;
            border-radius: 4px;
            background-color: #2A2A2A;
        }
        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="chart-container"></div>
    <div id="stats-container">
        <div class="stat-box">
            <div class="stat-label">BTC Price</div>
            <div class="stat-value" id="price">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">24h Liq. Count</div>
            <div class="stat-value" id="liq-count">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">24h Liq. Volume</div>
            <div class="stat-value" id="liq-volume">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Largest Liq.</div>
            <div class="stat-value" id="largest-liq">$0</div>
        </div>
    </div>
    <script>
        window.onload = async function() {
            let currentBar = null;
            const barInterval = 300; // 5 minutes
            
            // Stats tracking
            const stats = {
                liqCount24h: 0,
                liqVolume24h: 0,
                largestLiq: 0,
                currentPrice: 0
            };

            function updateStats() {
                document.getElementById('price').textContent = `$${stats.currentPrice.toFixed(2)}`;
                document.getElementById('liq-count').textContent = stats.liqCount24h;
                document.getElementById('liq-volume').textContent = `$${(stats.liqVolume24h/1000000).toFixed(2)}M`;
                document.getElementById('largest-liq').textContent = `$${(stats.largestLiq/1000000).toFixed(2)}M`;
            }

            const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
                width: window.innerWidth,
                height: window.innerHeight * 0.9,
                layout: {
                    background: { color: '#1E1E1E' },
                    textColor: '#D3D3D3'
                },
                grid: {
                    vertLines: { visible: false },
                    horzLines: { visible: false }
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false
                }
            });

            const barSeries = chart.addBarSeries({ 
                upColor: '#26a69a',
                downColor: '#ef5350'
            });

            // Series for liquidations
            const longLiqSeries = chart.addCandlestickSeries({
                upColor: 'rgba(255, 0, 0, 0)',
                downColor: 'rgba(255, 0, 0, 0.5)',
                borderVisible: false,
                wickVisible: false
            });

            const shortLiqSeries = chart.addCandlestickSeries({
                upColor: 'rgba(0, 255, 0, 0)',
                downColor: 'rgba(0, 255, 0, 0.5)',
                borderVisible: false,
                wickVisible: false
            });

            // Fetch historical data
            try {
                const response = await fetch('https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=USD&limit=2000&aggregate=5');
                const data = await response.json();
                if (data.Data && data.Data.Data) {
                    const historicalBars = data.Data.Data.map(item => ({
                        time: item.time,
                        open: item.open,
                        high: item.high,
                        low: item.low,
                        close: item.close
                    }));
                    barSeries.setData(historicalBars);
                    stats.currentPrice = historicalBars[historicalBars.length - 1].close;
                    updateStats();
                    chart.timeScale().fitContent();
                }
            } catch (error) {
                console.error('Historical data fetch error:', error);
            }

            // Coinbase WebSocket for price data
            const coinbaseWs = new WebSocket('wss://ws-feed.exchange.coinbase.com');
            
            coinbaseWs.onopen = () => {
                console.log('Coinbase WebSocket connected');
                coinbaseWs.send(JSON.stringify({
                    type: 'subscribe',
                    product_ids: ['BTC-USD'],
                    channels: ['ticker']
                }));
            };

            coinbaseWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type !== 'ticker' || data.product_id !== 'BTC-USD') return;

                const price = parseFloat(data.price);
                stats.currentPrice = price;
                updateStats();

                const timestamp = Math.floor(Date.now() / 1000);
                const barTime = Math.floor(timestamp / barInterval) * barInterval;

                if (!currentBar || currentBar.time !== barTime) {
                    if (currentBar) {
                        barSeries.update(currentBar);
                    }
                    currentBar = {
                        time: barTime,
                        open: price,
                        high: price,
                        low: price,
                        close: price
                    };
                } else {
                    currentBar.high = Math.max(currentBar.high, price);
                    currentBar.low = Math.min(currentBar.low, price);
                    currentBar.close = price;
                    barSeries.update(currentBar);
                }

                chart.timeScale().scrollToRealTime();
            };

            // Bybit WebSocket for liquidation data
            const bybitWs = new WebSocket('wss://stream.bybit.com/v5/public/linear');
            
            bybitWs.onopen = () => {
                console.log('Bybit WebSocket connected');
                bybitWs.send(JSON.stringify({
                    op: 'subscribe',
                    args: ['liquidation.BTCUSDT']
                }));
            };

            bybitWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.topic === 'liquidation.BTCUSDT' && data.data) {
                    const liquidation = data.data;
                    const price = parseFloat(liquidation.price);
                    const size = parseFloat(liquidation.size);
                    const side = liquidation.side;
                    const timestamp = Math.floor(Date.now() / 1000);

                    // Update liquidation statistics
                    stats.liqCount24h++;
                    const liqValue = size * price;
                    stats.liqVolume24h += liqValue;
                    stats.largestLiq = Math.max(stats.largestLiq, liqValue);
                    updateStats();

                    const marker = {
                        time: timestamp,
                        open: price,
                        high: price * (1 + size/10000),
                        low: price * (1 - size/10000),
                        close: price
                    };

                    if (side === 'Buy') {
                        longLiqSeries.update(marker);
                    } else {
                        shortLiqSeries.update(marker);
                    }
                }
            };

            // Error handling
            coinbaseWs.onerror = (error) => console.error('Coinbase WebSocket error:', error);
            bybitWs.onerror = (error) => console.error('Bybit WebSocket error:', error);

            // Auto-reconnect on close
            coinbaseWs.onclose = () => {
                console.log('Coinbase WebSocket closed, reconnecting...');
                setTimeout(() => window.location.reload(), 5000);
            };
            bybitWs.onclose = () => {
                console.log('Bybit WebSocket closed, reconnecting...');
                setTimeout(() => window.location.reload(), 5000);
            };

            // Handle window resize
            window.addEventListener('resize', () => {
                chart.resize(window.innerWidth, window.innerHeight * 0.9);
            });
        };
    </script>
</body>
</html>
