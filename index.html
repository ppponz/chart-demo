<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC Price and Liquidations</title>
    <script src="https://unpkg.com/lightweight-charts@3.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #0d1117;
            color: #D3D3D3;
        }
        #container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #header {
            text-align: center;
            padding: 15px;
            background: #161b22;
            border-radius: 8px;
        }
        #header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #00E676;
        }
        .chart-wrapper {
            height: 500px;
            background-color: #161b22;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            margin-bottom: 20px;
        }
        #liq-chart {
            height: 200px;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #loading-text {
            color: #00E676;
            font-size: 1.2em;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
        }
        .stat-label {
            font-size: 0.9em;
            color: #888;
        }
        .stat-value {
            font-size: 1.2em;
            margin-top: 5px;
        }
        .long { color: #26a69a; }
        .short { color: #ef5350; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div id="loading-text">Loading historical data...</div>
    </div>
    <div id="container">
        <div id="header">
            <h1>BTC-USD Price & Liquidations</h1>
        </div>
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">Long Liquidations</div>
                <div class="stat-value long" id="long-liq">0 BTC</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Short Liquidations</div>
                <div class="stat-value short" id="short-liq">0 BTC</div>
            </div>
        </div>
        <div id="price-chart" class="chart-wrapper"></div>
        <div id="liq-chart" class="chart-wrapper"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const priceChartContainer = document.getElementById('price-chart');
            const liqChartContainer = document.getElementById('liq-chart');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            
            let historicalData = [];
            let liquidations = [];
            let currentBar = null;

            // Initialize charts
            const priceChart = LightweightCharts.createChart(priceChartContainer, {
                width: priceChartContainer.offsetWidth,
                height: priceChartContainer.offsetHeight,
                layout: { background: { color: '#161b22' }, textColor: '#D3D3D3' },
                grid: { vertLines: { color: '#2A2A2A' }, horzLines: { color: '#2A2A2A' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2A2A2A' },
                rightPriceScale: { borderColor: '#2A2A2A' }
            });

            const liqChart = LightweightCharts.createChart(liqChartContainer, {
                width: liqChartContainer.offsetWidth,
                height: liqChartContainer.offsetHeight,
                layout: { background: { color: '#161b22' }, textColor: '#D3D3D3' },
                grid: { vertLines: { visible: false }, horzLines: { color: '#2A2A2A' } },
                timeScale: { visible: true, timeVisible: true, secondsVisible: false, borderColor: '#2A2A2A' },
                rightPriceScale: { borderColor: '#2A2A2A' }
            });

            const candleSeries = priceChart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
                wickUpColor: '#26a69a', wickDownColor: '#ef5350'
            });

            const longLiqSeries = liqChart.addHistogramSeries({ color: '#ef5350', priceFormat: { type: 'volume' } });
            const shortLiqSeries = liqChart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' } });

            // Fetch historical data with improved error handling
            async function fetchHistoricalData() {
                const maxRetries = 5;
                let retryCount = 0;
                let delay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        const endTime = new Date();
                        const startTime = new Date(endTime - (300 * 300 * 1000));
                        const url = `https://api.pro.coinbase.com/products/BTC-USD/candles?start=${startTime.toISOString()}&end=${endTime.toISOString()}&granularity=300`;
                        console.log(`Fetching historical data from: ${url}`);

                        const response = await fetch(url, { method: 'GET', headers: { 'User-Agent': 'BTC-Chart/1.0' } });
                        console.log(`Response status: ${response.status}`);

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        if (!Array.isArray(data)) {
                            throw new Error(`Unexpected response format: ${JSON.stringify(data)}`);
                        }

                        historicalData = data.map(candle => ({
                            time: candle[0],
                            open: candle[3],
                            high: candle[2],
                            low: candle[1],
                            close: candle[4]
                        })).reverse();

                        candleSeries.setData(historicalData);
                        priceChart.timeScale().fitContent();
                        loadingOverlay.style.display = 'none';
                        return true;
                    } catch (error) {
                        console.error(`Retry ${retryCount + 1}/${maxRetries} - Error:`, error.message);
                        retryCount++;
                        if (retryCount === maxRetries) {
                            loadingText.textContent = 'Failed to load historical data. Using live data...';
                            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 2000);
                            return false;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }

            // Coinbase WebSocket with reconnection
            function connectCoinbaseWebSocket() {
                const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
                
                ws.onopen = () => {
                    console.log('Coinbase WebSocket connected');
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        product_ids: ['BTC-USD'],
                        channels: ['ticker']
                    }));
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'ticker' && data.product_id === 'BTC-USD' && data.price) {
                            const price = parseFloat(data.price);
                            const timestamp = Math.floor(Date.now() / 1000);
                            const barTime = Math.floor(timestamp / 300) * 300;

                            if (!currentBar || currentBar.time !== barTime) {
                                if (currentBar) candleSeries.update(currentBar);
                                currentBar = { time: barTime, open: price, high: price, low: price, close: price };
                            } else {
                                currentBar.high = Math.max(currentBar.high, price);
                                currentBar.low = Math.min(currentBar.low, price);
                                currentBar.close = price;
                            }
                            candleSeries.update(currentBar);
                        }
                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                };

                ws.onerror = (error) => console.error('Coinbase WebSocket error:', error);
                ws.onclose = () => {
                    console.log('Coinbase WebSocket closed. Reconnecting in 2s...');
                    setTimeout(connectCoinbaseWebSocket, 2000);
                };

                return ws;
            }

            // Bybit WebSocket with reconnection
            function connectBybitWebSocket() {
                const ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
                
                ws.onopen = () => {
                    console.log('Bybit WebSocket connected');
                    ws.send(JSON.stringify({ op: 'subscribe', args: ['liquidation.BTCUSDT'] }));
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.topic === 'liquidation.BTCUSDT' && data.data) {
                            const { side, qty, time } = data.data;
                            const timestamp = Math.floor(parseInt(time) / 1000);
                            const liqValue = parseFloat(qty);

                            liquidations.push({ time: timestamp, qty: liqValue, side });
                            updateLiquidationStats();
                        }
                    } catch (error) {
                        console.error('Bybit WebSocket message error:', error);
                    }
                };

                ws.onerror = (error) => console.error('Bybit WebSocket error:', error);
                ws.onclose = () => {
                    console.log('Bybit WebSocket closed. Reconnecting in 2s...');
                    setTimeout(connectBybitWebSocket, 2000);
                };

                return ws;
            }

            function updateLiquidationStats() {
                const now = Date.now() / 1000;
                const cutoff = now - 24 * 60 * 60;
                liquidations = liquidations.filter(liq => liq.time >= cutoff);

                const longLiqs = liquidations.filter(liq => liq.side === 'Buy');
                const shortLiqs = liquidations.filter(liq => liq.side === 'Sell');
                
                const longVolume = longLiqs.reduce((sum, liq) => sum + liq.qty, 0);
                const shortVolume = shortLiqs.reduce((sum, liq) => sum + liq.qty, 0);

                document.getElementById('long-liq').textContent = `${longVolume.toFixed(2)} BTC`;
                document.getElementById('short-liq').textContent = `${shortVolume.toFixed(2)} BTC`;

                longLiqSeries.setData(longLiqs.map(liq => ({
                    time: liq.time,
                    value: liq.qty,
                    color: liq.qty > 10 ? '#ff0000' : '#ef5350'
                })));

                shortLiqSeries.setData(shortLiqs.map(liq => ({
                    time: liq.time,
                    value: liq.qty,
                    color: liq.qty > 10 ? '#00ff00' : '#26a69a'
                })));

                liqChart.timeScale().fitContent();
            }

            // Main execution
            const historicalSuccess = await fetchHistoricalData();
            const coinbaseWs = connectCoinbaseWebSocket();
            const bybitWs = connectBybitWebSocket();

            // Fallback: Start with dummy bar if historical data fails
            if (!historicalSuccess && !currentBar) {
                const now = Math.floor(Date.now() / 1000);
                const barTime = Math.floor(now / 300) * 300;
                currentBar = { time: barTime, open: 0, high: 0, low: 0, close: 0 };
                candleSeries.setData([currentBar]);
            }

            // Resize handler
            window.addEventListener('resize', () => {
                priceChart.resize(priceChartContainer.offsetWidth, priceChartContainer.offsetHeight);
                liqChart.resize(liqChartContainer.offsetWidth, liqChartContainer.offsetHeight);
            });

            // Cleanup
            window.addEventListener('unload', () => {
                coinbaseWs.close();
                bybitWs.close();
            });
        });
    </script>
</body
