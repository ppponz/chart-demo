<!DOCTYPE html>
<html lang="en">
<head>
    <title>Coinbase BTC/USD 30-Second Bars (Fastest)</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; }
        #chart-container { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="chart-container"></div>
    <script>
        window.onload = function() {
            console.log('Window loaded');

            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts failed to load');
                return;
            }
            console.log('LightweightCharts loaded');

            const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
                width: window.innerWidth,
                height: window.innerHeight,
                layout: { background: { color: '#ffffff' }, textColor: 'black' },
                grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                timeScale: { timeVisible: true, secondsVisible: true }
            });
            console.log('Chart created');

            const barSeries = chart.addBarSeries({ color: '#2962FF' });
            console.log('Bar series created');

            let currentBar = null;
            const barInterval = 30; // 30 seconds

            // Starter data (last 5 minutes as one bar for context)
            const now = Math.floor(Date.now() / 1000);
            fetch('https://api.coinbase.com/v2/prices/BTC-USD/spot')
                .then(response => response.json())
                .then(data => {
                    const price = parseFloat(data.data.amount);
                    barSeries.setData([
                        { time: now - 300, open: price, high: price, low: price, close: price }
                    ]);
                    console.log('Starter bar set:', price);
                })
                .catch(error => console.error('Starter fetch error:', error));

            const socket = new WebSocket('wss://ws-feed.exchange.coinbase.com');
            socket.onopen = () => {
                console.log('WebSocket connected');
                socket.send(JSON.stringify({
                    type: 'subscribe',
                    product_ids: ['BTC-USD'],
                    channels: ['ticker']
                }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type !== 'ticker' || data.product_id !== 'BTC-USD') return;

                const price = parseFloat(data.price);
                const timestamp = Math.floor(Date.now() / 1000);
                const barTime = Math.floor(timestamp / barInterval) * barInterval;

                console.log('Trade:', price, 'at', timestamp);

                if (!currentBar || currentBar.time !== barTime) {
                    if (currentBar) {
                        barSeries.update(currentBar);
                        console.log('Bar completed:', currentBar);
                    }
                    currentBar = {
                        time: barTime,
                        open: price,
                        high: price,
                        low: price,
                        close: price
                    };
                    console.log('New bar:', currentBar);
                } else {
                    currentBar.high = Math.max(currentBar.high, price);
                    currentBar.low = Math.min(currentBar.low, price);
                    currentBar.close = price;
                    barSeries.update(currentBar);
                }

                chart.timeScale().scrollToRealTime();
            };

            socket.onerror = (error) => console.error('WebSocket error:', error);
            socket.onclose = () => console.log('WebSocket closed');

            window.addEventListener('resize', () => {
                chart.resize(window.innerWidth, window.innerHeight);
            });
        };
    </script>
</body>
</html>
