<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC/USD Chart with Liquidations and Historical Data</title>
    <script src="https://unpkg.com/lightweight-charts@3.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        #chart-container {
            width: 100vw;
            height: 90vh;
            background-color: #1E1E1E;
        }
        #price-label, #liq-stats, #hist-liq-stats {
            position: absolute;
            left: 10px;
            color: #D3D3D3;
            font-size: 1em;
            background: rgba(42, 42, 42, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        #price-label {
            top: 10px;
        }
        #liq-stats {
            top: 50px;
        }
        #hist-liq-stats {
            bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="chart-container"></div>
    <div id="price-label">$0</div>
    <div id="liq-stats">Liquidations (24h):\nTotal: 0 BTC\nLongs: 0\nShorts: 0</div>
    <div id="hist-liq-stats">Loading historical liquidation data...</div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('chart-container');
            const priceLabel = document.getElementById('price-label');
            const liqStatsLabel = document.getElementById('liq-stats');
            const histLiqStatsLabel = document.getElementById('hist-liq-stats');

            const chart = LightweightCharts.createChart(container, {
                width: window.innerWidth,
                height: window.innerHeight * 0.9,
                layout: { background: { color: '#1E1E1E' }, textColor: '#D3D3D3' },
                grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                timeScale: { timeVisible: true, secondsVisible: false },
                rightPriceScale: { borderColor: '#2A2A2A' }
            });

            const barSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350'
            });

            const longLiqSeries = chart.addHistogramSeries({ color: 'rgba(255, 0, 0, 0.7)', priceLineVisible: false });
            const shortLiqSeries = chart.addHistogramSeries({ color: 'rgba(0, 255, 0, 0.7)', priceLineVisible: false });

            let liquidations = [];
            let currentBar = null;

            async function fetchHistoricalData() {
                try {
                    const endTime = Math.floor(Date.now() / 1000); // Current time in seconds
                    const maxLookbackInMs = 365 * 24 * 60 * 60 * 1000; // 1 year in ms
                    const startTime = endTime - Math.floor(maxLookbackInMs / 1000); // Convert to seconds
                    let allBars = [];
                    let fromTime = startTime;

                    while (fromTime < endTime) {
                        const response = await fetch(
                            `https://api.bybit.com/v5/market/kline?category=linear&symbol=BTCUSDT&interval=5&start=${fromTime * 1000}&limit=100`
                        );
                        if (!response.ok) throw new Error(`Bybit API failed: ${response.status}`);
                        const data = await response.json();

                        const candles = data.result.list.map(candle => ({
                            time: Math.floor(parseInt(candle[0]) / 1000), // Convert ms to s
                            open: parseFloat(candle[1]),
                            high: parseFloat(candle[2]),
                            low: parseFloat(candle[3]),
                            close: parseFloat(candle[4])
                        })).reverse(); // Oldest to newest

                        allBars = allBars.concat(candles);
                        fromTime = Math.floor(parseInt(data.result.list[0][0]) / 1000) + 300; // Next start time in seconds (5min interval)
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limit delay
                    }

                    console.log('Historical bars:', allBars);
                    barSeries.setData(allBars);
                    const lastBar = allBars[allBars.length - 1];
                    priceLabel.textContent = `$${lastBar.close.toFixed(2)}`;
                    chart.timeScale().fitContent();
                } catch (error) {
                    console.error('Historical data fetch error:', error);
                    priceLabel.textContent = 'Error loading historical data';
                }
            }

            async function fetchHistoricalLiquidationData() {
                try {
                    // Placeholder: Replace with actual Bybit historical liquidation endpoint if available
                    histLiqStatsLabel.textContent = 'Historical liquidation data not implemented yet.';
                    // Example (uncomment and adjust if you have an endpoint):
                    // const response = await fetch('https://api.bybit.com/v5/some-liquidation-endpoint');
                    // const data = await response.json();
                    // histLiqStatsLabel.textContent = `Historical Liquidations:\nTotal: ${data.total} BTC\nLongs: ${data.longs}\nShorts: ${data.shorts}`;
                } catch (error) {
                    console.error('Error fetching historical liquidation data:', error);
                    histLiqStatsLabel.textContent = 'Error loading historical liquidation data.';
                }
            }

            const bybitWs = new WebSocket('wss://stream.bybit.com/v5/public/linear');
            bybitWs.onopen = () => {
                console.log('Bybit WebSocket connected');
                bybitWs.send(JSON.stringify({
                    op: 'subscribe',
                    args: ['liquidation.BTCUSDT']
                }));
            };
            bybitWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Bybit WS message:', data);

                if (data.topic === 'liquidation.BTCUSDT' && data.data) {
                    const { symbol, price, side, qty } = data.data;
                    if (!symbol.includes('BTCUSDT')) return;

                    const timestamp = Math.floor(Date.now() / 1000);
                    const liqValue = parseFloat(qty) || 0;
                    const threshold = 10;

                    const series = side === 'Buy' ? longLiqSeries : shortLiqSeries;
                    const color = liqValue > threshold ? (side === 'Buy' ? '#FF5555' : '#55FF55') : series.options().color;

                    series.update({
                        time: timestamp,
                        value: liqValue,
                        color: color
                    });

                    liquidations.push({ time: timestamp, qty: liqValue, side });
                    updateLiqStats();
                }
            };
            bybitWs.onerror = (error) => console.error('Bybit WS error:', error);
            bybitWs.onclose = () => console.log('Bybit WS closed');

            function updateLiqStats() {
                const now = Date.now() / 1000;
                const cutoff = now - 24 * 60 * 60;
                liquidations = liquidations.filter(liq => liq.time >= cutoff);

                const totalVolume = liquidations.reduce((sum, liq) => sum + liq.qty, 0);
                const longCount = liquidations.filter(liq => liq.side === 'Buy').length;
                const shortCount = liquidations.filter(liq => liq.side === 'Sell').length;

                liqStatsLabel.textContent = `Liquidations (24h):\nTotal: ${totalVolume.toFixed(2)} BTC\nLongs: ${longCount}\nShorts: ${shortCount}`;
            }

            // Initial data load
            await fetchHistoricalData();
            await fetchHistoricalLiquidationData();

            // Periodic updates
            setInterval(updateLiqStats, 60000);

            // Handle window resize
            window.addEventListener('resize', () => {
                chart.resize(window.innerWidth, window.innerHeight * 0.9);
            });

            // Cleanup on unload
            window.addEventListener('unload', () => {
                bybitWs.close();
            });
        });
    </script>
</body>
</html>
