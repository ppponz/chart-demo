<!DOCTYPE html>
<html lang="en">
<head>
    <title>Coinbase BTC/USD 5-Minute Bars (Max History)</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; }
        #chart-container { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="chart-container"></div>
    <script>
        window.onload = async function() {
            console.log('Window loaded');

            if (typeof LightweightCharts === 'undefined') {
                console.error('LightweightCharts failed to load');
                return;
            }
            console.log('LightweightCharts loaded');

            const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
                width: window.innerWidth,
                height: window.innerHeight,
                layout: { background: { color: '#1E1E1E' }, textColor: '#D3D3D3' }, // Grok-like colors
                grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                timeScale: { timeVisible: true, secondsVisible: false } // No seconds for 5-min bars
            });
            console.log('Chart created');

            const barSeries = chart.addBarSeries({ color: '#2962FF' });
            console.log('Bar series created');

            let currentBar = null;
            const barInterval = 300; // 5 minutes in seconds

            // Fetch max historical 5-minute bars (~7 days)
            const url = 'https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=USD&limit=2000&aggregate=5';
            console.log('Fetching historical data...');
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Fetch failed');
                const data = await response.json();
                if (!data.Data || !data.Data.Data) throw new Error('No data returned');
                const historicalBars = data.Data.Data.map(item => ({
                    time: item.time,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close
                }));
                barSeries.setData(historicalBars);
                console.log('Historical data loaded:', historicalBars.length, 'bars');
                chart.timeScale().fitContent();
            } catch (error) {
                console.error('Historical fetch error:', error);
            }

            const socket = new WebSocket('wss://ws-feed.exchange.coinbase.com');
            socket.onopen = () => {
                console.log('WebSocket connected');
                socket.send(JSON.stringify({
                    type: 'subscribe',
                    product_ids: ['BTC-USD'],
                    channels: ['ticker']
                }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type !== 'ticker' || data.product_id !== 'BTC-USD') return;

                const price = parseFloat(data.price);
                const timestamp = Math.floor(Date.now() / 1000);
                const barTime = Math.floor(timestamp / barInterval) * barInterval;

                if (!currentBar || currentBar.time !== barTime) {
                    if (currentBar) {
                        barSeries.update(currentBar);
                        console.log('Bar completed:', currentBar);
                    }
                    currentBar = {
                        time: barTime,
                        open: price,
                        high: price,
                        low: price,
                        close: price
                    };
                    console.log('New bar:', currentBar);
                } else {
                    currentBar.high = Math.max(currentBar.high, price);
                    currentBar.low = Math.min(currentBar.low, price);
                    currentBar.close = price;
                    barSeries.update(currentBar);
                }

                chart.timeScale().scrollToRealTime();
            };

            socket.onerror = (error) => console.error('WebSocket error:', error);
            socket.onclose = () => console.log('WebSocket closed');

            window.addEventListener('resize', () => {
                chart.resize(window.innerWidth, window.innerHeight);
            });
        };
    </script>
</body>
</html>
