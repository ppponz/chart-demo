<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC/USD 5-min Chart with Liquidations</title>
    <script src="/chart-demo/scripts/lightweight-charts.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        #chart-container {
            width: 100vw;
            height: 100vh;
            background-color: #1E1E1E;
        }
        #price-label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #D3D3D3;
            font-size: 1.2em;
            background: rgba(42, 42, 42, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="chart-container"></div>
    <div id="price-label">$0</div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof LightweightCharts === 'undefined') {
                console.error('Lightweight Charts not loaded - check scripts/lightweight-charts.js');
                return;
            }
            console.log('Lightweight Charts version:', LightweightCharts.version());

            const container = document.getElementById('chart-container');
            const priceLabel = document.getElementById('price-label');
            const barInterval = 300; // 5 minutes in seconds
            let currentBar = null;
            let bars = [];

            const chart = LightweightCharts.createChart(container, {
                width: window.innerWidth,
                height: window.innerHeight,
                layout: { background: { color: '#1E1E1E' }, textColor: '#D3D3D3' },
                grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                timeScale: { timeVisible: true, secondsVisible: false },
                rightPriceScale: { borderColor: '#2A2A2A' }
            });

            const barSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350'
            });

            const longLiqSeries = chart.addScatterSeries({ color: 'rgba(255, 0, 0, 0.7)', radius: 2 });
            const shortLiqSeries = chart.addScatterSeries({ color: 'rgba(0, 255, 0, 0.7)', radius: 2 });

            // Fetch max historical 5-min data from Coinbase (up to ~1 week)
            async function fetchHistoricalData() {
                try {
                    const endTime = Math.floor(Date.now() / 1000);
                    const maxBars = 2000; // ~1 week of 5-min bars
                    const granularity = barInterval;
                    let allBars = [];
                    let startTime = endTime - (maxBars * granularity);

                    while (startTime < endTime) {
                        const response = await fetch(
                            `https://api.coinbase.com/v2/prices/BTC-USD/historic?start=${startTime}&end=${Math.min(startTime + 300 * granularity, endTime)}&granularity=${granularity}`
                        );
                        if (!response.ok) throw new Error(`Coinbase API failed: ${response.status}`);
                        const data = await response.json();
                        const candles = data.data.prices.map(candle => ({
                            time: Math.floor(new Date(candle.time).getTime() / 1000),
                            open: parseFloat(candle.open),
                            high: parseFloat(candle.high),
                            low: parseFloat(candle.low),
                            close: parseFloat(candle.close)
                        })).reverse();
                        allBars = allBars.concat(candles);
                        startTime += 300 * granularity;
                        await new Promise(resolve => setTimeout(resolve, 500)); // Rate limit delay
                    }

                    bars = allBars;
                    barSeries.setData(bars);
                    const lastBar = bars[bars.length - 1];
                    priceLabel.textContent = `$${lastBar.close.toFixed(2)}`;
                    chart.timeScale().fitContent();
                } catch (error) {
                    console.error('Historical data fetch error:', error);
                }
            }

            // Coinbase Advanced Trade WebSocket
            const coinbaseWs = new WebSocket('wss://advanced-trade-ws.coinbase.com');
            coinbaseWs.onopen = () => {
                console.log('Coinbase WebSocket connected');
                coinbaseWs.send(JSON.stringify({
                    type: 'subscribe',
                    product_ids: ['BTC-USD'],
                    channel: 'ticker'
                }));
            };
            coinbaseWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.channel !== 'ticker' || data.events?.[0]?.tickers?.[0]?.product_id !== 'BTC-USD') return;

                const price = parseFloat(data.events[0].tickers[0].price);
                const timestamp = Math.floor(Date.now() / 1000);
                const barTime = Math.floor(timestamp / barInterval) * barInterval;

                priceLabel.textContent = `$${price.toFixed(2)}`;

                if (!currentBar || currentBar.time !== barTime) {
                    if (currentBar) barSeries.update(currentBar);
                    currentBar = { time: barTime, open: price, high: price, low: price, close: price };
                } else {
                    currentBar.high = Math.max(currentBar.high, price);
                    currentBar.low = Math.min(currentBar.low, price);
                    currentBar.close = price;
                    barSeries.update(currentBar);
                }
            };
            coinbaseWs.onerror = (error) => console.error('Coinbase WS error:', error);
            coinbaseWs.onclose = () => console.log('Coinbase WS closed');

            // Bybit WebSocket for liquidations
            const bybitWs = new WebSocket('wss://stream.bybit.com/v5/public/linear');
            bybitWs.onopen = () => {
                console.log('Bybit WebSocket connected');
                bybitWs.send(JSON.stringify({
                    op: 'subscribe',
                    args: ['liquidation.all']
                }));
            };
            bybitWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.topic !== 'liquidation.all' || !data.data) return;

                const { symbol, price, side } = data.data;
                if (symbol !== 'BTCUSDT') return;
                const timestamp = Math.floor(Date.now() / 1000);
                const marker = { time: timestamp, value: parseFloat(price) };
                (side === 'Buy' ? longLiqSeries : shortLiqSeries).update(marker);
            };
            bybitWs.onerror = (error) => console.error('Bybit WS error:', error);
            bybitWs.onclose = () => console.log('Bybit WS closed');

            window.addEventListener('resize', () => chart.resize(window.innerWidth, window.innerHeight));
            window.addEventListener('unload', () => {
                coinbaseWs.close();
                bybitWs.close();
            });

            await fetchHistoricalData();
        });
    </script>
</body>
</html>
