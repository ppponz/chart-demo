<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC Price, Liquidations, CVD, and OI</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow-x: hidden; font-family: 'Arial', sans-serif; background-color: #0d1117; color: #D3D3D3; }
        #container { max-width: 1400px; margin: 10px auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        #header { text-align: center; padding: 10px; background: #161b22; border-radius: 8px; }
        #header h1 { margin: 0; font-size: 1.2em; color: #888888; }
        #price-chart { height: 230px; background-color: #161b22; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); overflow: hidden; }
        .chart-wrapper { height: 150px; background-color: #161b22; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); overflow: hidden; }
        #loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #loading-text { color: #00E676; font-size: 1.2em; }
        #kraken-status { position: fixed; top: 10px; right: 10px; padding: 5px 10px; background: #161b22; border-radius: 4px; font-size: 0.9em; }
        #bybit-status { position: fixed; top: 35px; right: 10px; padding: 5px 10px; background: #161b22; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div id="loading-text">Loading historical data...</div></div>
    <div id="container">
        <div id="header"><h1>BTC-USD Price, Liquidations, CVD, and OI</h1></div>
        <div id="price-chart"></div>
        <div id="liq-chart" class="chart-wrapper"></div>
        <div id="cvd-chart" class="chart-wrapper"></div>
        <div id="oi-chart" class="chart-wrapper"></div>
    </div>
    <div id="kraken-status">Kraken: Connecting</div>
    <div id="bybit-status">Bybit: Connecting</div>
    <script>
        (async () => {
            // ... [Previous constants and setup code remains the same until WebSocket handlers] ...

            // Enhanced data validation function
            const isValidDataPoint = (point) => {
                return point && 
                       typeof point === 'object' &&
                       Number.isFinite(point.time) && 
                       Number.isFinite(point.value) &&
                       !isNaN(point.time) && 
                       !isNaN(point.value) &&
                       point.value !== null;
            };

            // Improved CVD data handling
            let lastValidCvdTime = Math.floor(Date.now() / 1000);
            let lastValidCvdValue = 0;

            // Modified Bybit WebSocket handler
            const bybitWs = createWebSocket(
                BYBIT_WS_URL,
                (ws) => ws.send(JSON.stringify({ op: 'subscribe', args: ['publicTrade.BTCUSDT', 'liquidation.BTCUSDT'] })),
                (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Handle liquidation data
                        if (data.topic === 'liquidation.BTCUSDT' && data.data) {
                            const { side, qty, time } = data.data;
                            const timestamp = Math.floor(parseInt(time) / 1000);
                            const liqValue = parseFloat(qty);
                            
                            if (Number.isFinite(timestamp) && Number.isFinite(liqValue)) {
                                liquidations.push({ time: timestamp, qty: liqValue, side });
                                updateLiquidationChart();
                            }
                        }

                        // Handle trade data with improved validation
                        if (data.topic === 'publicTrade.BTCUSDT' && Array.isArray(data.data) && data.data.length > 0) {
                            const trades = data.data;
                            
                            trades.forEach(trade => {
                                const volume = parseFloat(trade.v);
                                const side = trade.S === 'Buy' ? 1 : -1;
                                const timestamp = Math.floor(parseInt(trade.T) / 1000);

                                if (Number.isFinite(volume) && Number.isFinite(timestamp)) {
                                    cvdCumulative += volume * side;
                                    
                                    // Ensure we don't create duplicate timestamps
                                    if (timestamp > lastValidCvdTime) {
                                        const newPoint = {
                                            time: timestamp,
                                            value: cvdCumulative
                                        };

                                        if (isValidDataPoint(newPoint)) {
                                            // Remove any points with the same timestamp
                                            cvdData = cvdData.filter(d => d.time !== timestamp);
                                            cvdData.push(newPoint);
                                            
                                            // Sort and limit data points
                                            cvdData.sort((a, b) => a.time - b.time);
                                            if (cvdData.length > MAX_BARS) {
                                                cvdData = cvdData.slice(-MAX_BARS);
                                            }

                                            lastValidCvdTime = timestamp;
                                            lastValidCvdValue = cvdCumulative;

                                            // Ensure all data points are valid before updating
                                            const validData = cvdData.filter(isValidDataPoint);
                                            if (validData.length > 0) {
                                                cvdSeries.setData(validData);
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Bybit WebSocket processing error:', error);
                    }
                },
                'Bybit',
                elements.bybitStatus
            );

            // ... [Rest of the code remains the same] ...

        })();
    </script>
</body>
</html>
