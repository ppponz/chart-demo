<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC Price and Liquidations</title>
    <script src="https://unpkg.com/lightweight-charts@3.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Styles unchanged, omitted for brevity -->
</head>
<body>
    <div id="loading-overlay">
        <div id="loading-text">Loading historical data...</div>
    </div>
    <div id="container">
        <div id="header"><h1>BTC-USD Price & Liquidations</h1></div>
        <div class="stats-panel">
            <div class="stat-item"><div class="stat-label">Long Liquidations</div><div class="stat-value long" id="long-liq">0 BTC</div></div>
            <div class="stat-item"><div class="stat-label">Short Liquidations</div><div class="stat-value short" id="short-liq">0 BTC</div></div>
        </div>
        <div id="price-chart" class="chart-wrapper"></div>
        <div id="liq-chart" class="chart-wrapper"></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const priceChartContainer = document.getElementById('price-chart');
            const liqChartContainer = document.getElementById('liq-chart');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            
            let historicalData = [];
            let liquidations = [];
            let currentBar = null;

            // Chart setup (unchanged, omitted for brevity)
            const priceChart = LightweightCharts.createChart(priceChartContainer, { /* ... */ });
            const liqChart = LightweightCharts.createChart(liqChartContainer, { /* ... */ });
            const candleSeries = priceChart.addCandlestickSeries({ /* ... */ });
            const longLiqSeries = liqChart.addHistogramSeries({ /* ... */ });
            const shortLiqSeries = liqChart.addHistogramSeries({ /* ... */ });

            // Fetch historical data with improved retry logic
            async function fetchHistoricalData() {
                const maxRetries = 3; // Reduced from 5 to minimize requests
                let retryCount = 0;
                let delay = 1000;
                let persistentFailure = false;

                while (retryCount < maxRetries) {
                    try {
                        const endTime = new Date();
                        const startTime = new Date(endTime - (300 * 300 * 1000));
                        const url = `https://api.pro.coinbase.com/products/BTC-USD/candles?start=${startTime.toISOString()}&end=${endTime.toISOString()}&granularity=300`;
                        console.log(`Attempt ${retryCount + 1}/${maxRetries} - Fetching: ${url}`);

                        const response = await fetch(url, { 
                            method: 'GET', 
                            headers: { 'User-Agent': 'BTC-Chart/1.0' } 
                        });
                        console.log(`Status: ${response.status}`);

                        if (!response.ok) {
                            const errorText = await response.text();
                            if (response.status === 503) {
                                console.warn('503 detected - Coinbase API may be down');
                                if (retryCount === maxRetries - 1) persistentFailure = true;
                            }
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        if (!Array.isArray(data)) throw new Error(`Invalid data: ${JSON.stringify(data)}`);

                        historicalData = data.map(candle => ({
                            time: candle[0],
                            open: candle[3],
                            high: candle[2],
                            low: candle[1],
                            close: candle[4]
                        })).reverse();

                        candleSeries.setData(historicalData);
                        priceChart.timeScale().fitContent();
                        loadingOverlay.style.display = 'none';
                        return true;
                    } catch (error) {
                        console.error(`Retry ${retryCount + 1}/${maxRetries} failed: ${error.message}`);
                        retryCount++;
                        if (retryCount === maxRetries || persistentFailure) {
                            loadingText.textContent = 'Coinbase API unavailable. Starting with live data...';
                            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 2000);
                            return false;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay = Math.min(delay * 2, 8000); // Cap at 8s to avoid excessive waits
                    }
                }
            }

            // WebSocket functions (unchanged from prior fix, omitted for brevity)
            function connectCoinbaseWebSocket() { /* ... */ }
            function connectBybitWebSocket() { /* ... */ }
            function updateLiquidationStats() { /* ... */ }

            // Ensure single execution
            let isFetching = false;
            async function initialize() {
                if (isFetching) return;
                isFetching = true;

                const historicalSuccess = await fetchHistoricalData();
                const coinbaseWs = connectCoinbaseWebSocket();
                const bybitWs = connectBybitWebSocket();

                if (!historicalSuccess && !currentBar) {
                    const now = Math.floor(Date.now() / 1000);
                    const barTime = Math.floor(now / 300) * 300;
                    currentBar = { time: barTime, open: 0, high: 0, low: 0, close: 0 };
                    candleSeries.setData([currentBar]);
                }

                window.addEventListener('resize', () => {
                    priceChart.resize(priceChartContainer.offsetWidth, priceChartContainer.offsetHeight);
                    liqChart.resize(liqChartContainer.offsetWidth, liqChartContainer.offsetHeight);
                });

                window.addEventListener('unload', () => {
                    coinbaseWs.close();
                    bybitWs.close();
                });
            }

            initialize();
        });
    </script>
</body>
</html>
