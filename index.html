<!DOCTYPE html>
<html lang="en">
<head>
    <title>BTC/USD Chart with Liquidations</title>
    <!-- Use jsDelivr CDN with explicit version -->
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        /* Your existing styles remain unchanged */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #chart-container {
            position: relative;
            width: 100vw;
            height: 90vh;
            background-color: #1E1E1E;
        }
        #stats-container {
            width: 100vw;
            height: 10vh;
            background-color: #1E1E1E;
            color: #D3D3D3;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-sizing: border-box;
        }
        .stat-box {
            text-align: center;
            padding: 5px 15px;
            border-radius: 4px;
            background-color: #2A2A2A;
        }
        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="chart-container"></div>
    <div id="stats-container">
        <div class="stat-box">
            <div class="stat-label">BTC Price</div>
            <div class="stat-value" id="price">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">24h Liq. Count</div>
            <div class="stat-value" id="liq-count">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">24h Liq. Volume</div>
            <div class="stat-value" id="liq-volume">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Largest Liq.</div>
            <div class="stat-value" id="largest-liq">$0</div>
        </div>
    </div>
    <script>
        // Prevent wallet injection softly
        if (!window.ethereum) {
            window.ethereum = undefined;
        }

        // Wait for DOM and check library
        document.addEventListener('DOMContentLoaded', async function () {
            // Verify library is loaded
            if (typeof LightweightCharts === 'undefined') {
                console.error('Lightweight Charts library failed to load');
                return;
            }
            console.log('Lightweight Charts version:', LightweightCharts.version());

            const container = document.getElementById('chart-container');
            if (!container) {
                console.error('Chart container not found');
                return;
            }

            let currentBar = null;
            const barInterval = 300; // 5 minutes

            const stats = {
                liquidations: [],
                currentPrice: 0
            };

            function updateStats() {
                const now = Date.now();
                stats.liquidations = stats.liquidations.filter(l => now - l.timestamp < 24 * 60 * 60 * 1000);
                const liqCount24h = stats.liquidations.length;
                const liqVolume24h = stats.liquidations.reduce((sum, l) => sum + l.value, 0);
                const largestLiq = Math.max(...stats.liquidations.map(l => l.value), 0);

                document.getElementById('price').textContent = `$${stats.currentPrice.toFixed(2)}`;
                document.getElementById('liq-count').textContent = liqCount24h;
                document.getElementById('liq-volume').textContent = `$${(liqVolume24h / 1000000).toFixed(2)}M`;
                document.getElementById('largest-liq').textContent = `$${(largestLiq / 1000000).toFixed(2)}M`;
            }

            try {
                const chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: { background: { color: '#1E1E1E' }, textColor: '#D3D3D3' },
                    grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                    timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2A2A2A' },
                    rightPriceScale: { borderColor: '#2A2A2A' }
                });

                if (!chart.addCandlestickSeries) {
                    throw new Error('addCandlestickSeries method not available on chart object');
                }

                const barSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350'
                });

                const longLiqSeries = chart.addScatterSeries({
                    color: 'rgba(255, 0, 0, 0.7)',
                    radius: 2
                });

                const shortLiqSeries = chart.addScatterSeries({
                    color: 'rgba(0, 255, 0, 0.7)',
                    radius: 2
                });

                // Fetch historical data
                const response = await fetch('https://min-api.cryptocompare.com/data/v2/histominute?fsym=BTC&tsym=USD&limit=2000&aggregate=5');
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const data = await response.json();
                if (!data.Data || !data.Data.Data) throw new Error('Invalid API response format');

                const historicalBars = data.Data.Data.map(item => ({
                    time: item.time,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close
                }));
                barSeries.setData(historicalBars);
                stats.currentPrice = historicalBars[historicalBars.length - 1].close;
                updateStats();
                chart.timeScale().fitContent();

                // Coinbase WebSocket setup
                const coinbaseWs = new WebSocket('wss://ws-feed.exchange.coinbase.com');
                coinbaseWs.onopen = () => {
                    console.log('Coinbase WebSocket connected');
                    coinbaseWs.send(JSON.stringify({
                        type: 'subscribe',
                        product_ids: ['BTC-USD'],
                        channels: ['ticker']
                    }));
                };
                coinbaseWs.onerror = (error) => console.error('Coinbase WebSocket error:', error);
                coinbaseWs.onclose = () => console.log('Coinbase WebSocket closed');
                coinbaseWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type !== 'ticker' || data.product_id !== 'BTC-USD') return;

                    const price = parseFloat(data.price);
                    stats.currentPrice = price;
                    updateStats();

                    const timestamp = Math.floor(Date.now() / 1000);
                    const barTime = Math.floor(timestamp / barInterval) * barInterval;

                    if (!currentBar || currentBar.time !== barTime) {
                        if (currentBar) barSeries.update(currentBar);
                        currentBar = { time: barTime, open: price, high: price, low: price, close: price };
                    } else {
                        currentBar.high = Math.max(currentBar.high, price);
                        currentBar.low = Math.min(currentBar.low, price);
                        currentBar.close = price;
                        barSeries.update(currentBar);
                    }
                };

                // Bybit WebSocket setup
                const bybitWs = new WebSocket('wss://stream.bybit.com/v5/public/linear');
                bybitWs.onopen = () => {
                    console.log('Bybit WebSocket connected');
                    bybitWs.send(JSON.stringify({
                        op: 'subscribe',
                        args: ['liquidation.BTCUSDT']
                    }));
                };
                bybitWs.onerror = (error) => console.error('Bybit WebSocket error:', error);
                bybitWs.onclose = () => console.log('Bybit WebSocket closed');
                bybitWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.topic !== 'liquidation.BTCUSDT' || !data.data) return;

                    const liquidation = data.data;
                    const price = parseFloat(liquidation.price);
                    const size = parseFloat(liquidation.size);
                    const side = liquidation.side;
                    const timestamp = Math.floor(Date.now() / 1000);
                    const liqValue = size * price;

                    stats.liquidations.push({ timestamp: Date.now(), value: liqValue });
                    updateStats();

                    const marker = { time: timestamp, value: price };
                    if (side === 'Buy') {
                        longLiqSeries.update(marker);
                    } else {
                        shortLiqSeries.update(marker);
                    }
                };

                // Resize handler
                window.addEventListener('resize', () => {
                    chart.resize(container.clientWidth, container.clientHeight);
                });

                // Cleanup
                window.addEventListener('unload', () => {
                    coinbaseWs.close();
                    bybitWs.close();
                });

            } catch (error) {
                console.error('Chart initialization error:', error);
            }
        });
    </script>
</body>
</html>



